{% extends "base.html" %}
{% block content %}
<h1>Resumo (por cClass)</h1>

<div class="card">
  <form action="/resumo/gerar" method="post" enctype="multipart/form-data">
    <p><b>Envie um .zip</b> com XMLs:</p>
    <input type="file" name="zip_xmls" accept=".zip" required><br><br>
    <button class="btn" type="submit">Gerar Resumo</button>
  </form>
</div>

{% if resumo %}
<div class="card">
  {% if resumo.emitente_nome %}
  <p><b>Emitente:</b> {{ resumo.emitente_nome }}</p>
  <p><b>CNPJ/CPF:</b> {{ resumo.emitente_cnpj }}</p>
{% endif %}
<p><b>Total arquivos:</b> {{ resumo.total_arquivos }}</p>
  <p><b>Total geral:</b> {{ resumo.total_geral_br }}</p>

  {% if resumo.debug %}
  <div style="margin-top:10px; font-size:13px; opacity:.85;">
    <b>Diagnóstico:</b>
    XMLs no ZIP: {{ resumo.debug.total_xml }} |
    OK: {{ resumo.debug.total_ok }} |
    Falhas: {{ resumo.debug.total_falhas }}
    {% if resumo.debug.primeiro_erro %}
    <div style="margin-top:6px; white-space:pre-wrap;"><b>Primeiro erro:</b> {{ resumo.debug.primeiro_erro }}</div>
    {% endif %}
  </div>
  {% endif %}

</div>

<div class="card">
  <h3>Gráfico (Top 12 cClass)</h3>
  <div style="max-width:520px; max-height:320px;">
    <canvas id="pizza" style="width:100%; height:320px;"></canvas>
  </div>
</div>

<div class="card">
  <div style="display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap;">
    <h3 style="margin:0;">Tabela por cClass (3 níveis)</h3>
    <div style="display:flex; gap:10px;">
      <button type="button" class="btn" onclick="expandirTodosNiveis()">Expandir Todos</button>
      <button type="button" class="btn" onclick="recolherTodosNiveis()">Recolher Todos</button>
    </div>
  </div>

  <style>
    .acc-toggle {
      cursor: pointer;
      user-select: none;
      font-weight: bold;
      display: inline-block;
      width: 20px;
      text-align: center;
    }
    .nivel-cfop {
      background-color: #f5f5f5;
    }
    .nivel-nota {
      background-color: #f0f0f0;
    }
    .acc-box {
      padding: 10px;
      border-left: 3px solid #ddd;
    }
    .tbl {
      width: 100%;
      border-collapse: collapse;
    }
    .tbl th, .tbl td {
      border: 1px solid #ddd;
      padding: 8px;
    }
    .tbl th {
      background: #efefef;
    }
  </style>

  <table class="tbl">
    <thead>
      <tr>
        <th style="width:28px;"></th>
        <th>cClass</th>
        <th>Descrição</th>
        <th style="width:90px;">Qtd Itens</th>
        <th style="width:140px;">Valor Total</th>
        <th style="width:80px;">%</th>
      </tr>
    </thead>
    <tbody>
      {% for linha in resumo.linhas %}
      {% set cclass_id = "cc_" ~ loop.index0 %}
      <!-- Nível 1: cClass -->
      <tr>
        <td class="acc-toggle" onclick="toggleNivel('{{ cclass_id }}')">▶</td>
        <td>{{ linha.cClass }}</td>
        <td>{{ linha.desc }}</td>
        <td>{{ linha.qtd_itens }}</td>
        <td>{{ linha.v_total_br }}</td>
        <td>{{ linha.pct_br }}%</td>
      </tr>
      
      <!-- Nível 2: CFOPs (dentro do cClass) -->
      <tr id="{{ cclass_id }}" class="nivel-cfop" style="display:none;">
        <td colspan="6">
          <div class="acc-box">
            <table class="tbl" style="margin:0; background:#f9f9f9;">
              <tbody>
                {% for cfop in linha.cfops %}
                {% set cfop_id = cclass_id ~ "_cfop_" ~ loop.index0 %}
                <tr>
                  <td style="width:28px; padding-left:20px;">
                    <span class="acc-toggle" onclick="toggleNivel('{{ cfop_id }}')">▶</span>
                  </td>
                  <td style="font-weight:bold;">CFOP {{ cfop.cfop }}</td>
                  <td colspan="2"></td>
                  <td style="font-weight:bold;">{{ cfop.v_total_br }}</td>
                  <td></td>
                </tr>
                
                <!-- Nível 3: Notas (dentro do CFOP) -->
                <tr id="{{ cfop_id }}" class="nivel-nota" style="display:none;">
                  <td colspan="6">
                    <div style="padding-left:40px; background:#f0f0f0;">
                      <table class="tbl" style="margin:0; font-size:12px;">
                        <thead>
                          <tr>
                            <th style="width:90px;">nNF</th>
                            <th style="width:110px;">cNF</th>
                            <th>Emitente</th>
                            <th style="width:110px;">Emissão</th>
                            <th style="width:120px;">CFOP</th>
                            <th style="width:140px;">Valor</th>
                          </tr>
                        </thead>
                        <tbody>
                          {% for nota in cfop.notas %}
                          <tr>
                            <td>{{ nota.nNF }}</td>
                            <td>{{ nota.cNF }}</td>
                            <td>{{ nota.xNome }}</td>
                            <td>{{ nota.dhEmi_fmt }}</td>
                            <td>{{ nota.cfop }}</td>
                            <td>{{ nota.vProd_br }}</td>
                          </tr>
                          {% endfor %}
                        </tbody>
                      </table>
                    </div>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<div class="card">
  <div style="display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap;">
    <h3 style="margin:0;">Tabela de Itens (Todos)</h3>
    <div style="display:flex; gap:10px;">
      <button type="button" class="btn" onclick="expandirTodos()">Expandir Todos</button>
      <button type="button" class="btn" onclick="recolherTodos()">Recolher Todos</button>
    </div>
  </div>

  <style>
    tr.acc-detalhe {
      background: #f6f6f6;
    }
    table.table-interna {
      width: 100%;
      border-collapse: collapse;
      margin-top: 6px;
      font-size: 13px;
    }
    table.table-interna th, table.table-interna td {
      border: 1px solid #ddd;
      padding: 6px;
    }
    .num { text-align:right; }
  </style>

  <table>
    <thead>
      <tr>
        <th style="width:28px;"></th>
        <th>Item</th>
        <th style="width:90px;">cClass</th>
        <th style="width:90px;">Qtd Itens</th>
        <th style="width:140px;">Valor Total</th>
        <th style="width:80px;">%</th>
      </tr>
    </thead>
    <tbody>
      {% for it in resumo.itens_linhas %}
      {% set row_id = "acc_" ~ loop.index0 %}
      <tr>
        <td>
          <span class="acc-toggle" id="{{ row_id }}_ico" onclick="toggleAcc('{{ row_id }}')">▶</span>
        </td>
        <td>{{ it.item }}</td>
        <td>{{ it.cClass }}</td>
        <td class="num">{{ it.qtd_itens }}</td>
        <td class="num">{{ it.v_total_br }}</td>
        <td class="num">{{ it.pct_br }}%</td>
      </tr>

      <tr class="acc-detalhe" id="{{ row_id }}" style="display:none;">
        <td colspan="6">
          <div class="acc-box">
            <b>Notas fiscais relacionadas</b>
            {% if it.notas and it.notas|length > 0 %}
              <table class="table-interna">
                <thead>
                  <tr>
                    <th style="width:90px;">nNF</th>
                    <th style="width:120px;">Contrato (cNF)</th>
                    <th>Emitente (dest/xNome)</th>
                    <th style="width:110px;">Emissão</th>
                    <th style="width:140px;">Valor do item</th>
                  </tr>
                </thead>
                <tbody>
                  {% for n in it.notas %}
                  <tr>
                    <td>{{ n.nNF }}</td>
                    <td>{{ n.cNF }}</td>
                    <td>{{ n.xNome }}</td>
                    <td>{{ n.dhEmi_fmt }}</td>
                    <td class="num">{{ n.vProd_br }}</td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            {% else %}
              <div style="margin-top:8px; font-size:13px; opacity:0.85;">
                Nenhuma nota encontrada para este item.
              </div>
            {% endif %}
          </div>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<script>
  // Função para alternar qualquer nível
  function toggleNivel(id) {
    const element = document.getElementById(id);
    if (!element) return;
    
    const isOpen = element.style.display !== "none";
    element.style.display = isOpen ? "none" : "table-row";
    
    // Atualizar ícone do botão que acionou
    const toggleBtn = element.previousElementSibling?.querySelector('.acc-toggle') || 
                      document.querySelector(`[onclick*="${id}"]`);
    if (toggleBtn) {
      toggleBtn.textContent = isOpen ? "▶" : "▼";
    }
  }

  // Expandir todos os níveis
  function expandirTodosNiveis() {
    // Nível 2 (CFOPs)
    const nivel2 = document.querySelectorAll('.nivel-cfop');
    nivel2.forEach(el => {
      el.style.display = 'table-row';
      const toggleBtn = el.previousElementSibling?.querySelector('.acc-toggle');
      if (toggleBtn) toggleBtn.textContent = "▼";
    });
    
    // Nível 3 (Notas)
    const nivel3 = document.querySelectorAll('.nivel-nota');
    nivel3.forEach(el => {
      el.style.display = 'table-row';
      const toggleBtn = el.previousElementSibling?.querySelector('.acc-toggle');
      if (toggleBtn) toggleBtn.textContent = "▼";
    });
  }

  // Recolher todos os níveis
  function recolherTodosNiveis() {
    // Nível 3 (Notas)
    const nivel3 = document.querySelectorAll('.nivel-nota');
    nivel3.forEach(el => {
      el.style.display = 'none';
      const toggleBtn = el.previousElementSibling?.querySelector('.acc-toggle');
      if (toggleBtn) toggleBtn.textContent = "▶";
    });
    
    // Nível 2 (CFOPs)
    const nivel2 = document.querySelectorAll('.nivel-cfop');
    nivel2.forEach(el => {
      el.style.display = 'none';
      const toggleBtn = el.previousElementSibling?.querySelector('.acc-toggle');
      if (toggleBtn) toggleBtn.textContent = "▶";
    });
  }

  // Gráfico
  const labels = {{ resumo.labels|tojson }};
  const valores = {{ resumo.valores|tojson }};
  const ctx = document.getElementById("pizza");
  new Chart(ctx, {
    type: "pie",
    data: {
      labels: labels,
      datasets: [{ data: valores }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false
    }
  });

  // Accordion para itens
  function toggleAcc(id) {
    const row = document.getElementById(id);
    const ico = document.getElementById(id + "_ico");
    const aberto = row.style.display !== "none";

    row.style.display = aberto ? "none" : "table-row";
    ico.textContent = aberto ? "▶" : "▼";
  }

  function expandirTodos() {
    const detalhes = document.querySelectorAll("tr.acc-detalhe");
    detalhes.forEach(tr => {
      tr.style.display = "table-row";
      const ico = document.getElementById(tr.id + "_ico");
      if (ico) ico.textContent = "▼";
    });
  }

  function recolherTodos() {
    const detalhes = document.querySelectorAll("tr.acc-detalhe");
    detalhes.forEach(tr => {
      tr.style.display = "none";
      const ico = document.getElementById(tr.id + "_ico");
      if (ico) ico.textContent = "▶";
    });
  }
</script>
{% endif %}

{% endblock %}