{% extends "base.html" %}
{% block content %}
<h1>Resumo (por cClass)</h1>

<div class="card">
  <form action="/resumo/gerar" method="post" enctype="multipart/form-data">
    <p><b>Envie um .zip</b> com XMLs:</p>
    <input type="file" name="zip_xmls" accept=".zip" required><br><br>
    <button class="btn" type="submit">Gerar Resumo</button>
  </form>
</div>

{% if resumo %}
<div class="card">
  {% if resumo.emitente_nome %}
  <p><b>Emitente:</b> {{ resumo.emitente_nome }}</p>
  {% endif %}
  {% if resumo.emitente_cnpj %}
  <p><b>CNPJ:</b> {{ resumo.emitente_cnpj }}</p>
  {% endif %}
  <p><b>Total arquivos:</b> {{ resumo.total_arquivos }}</p>
  <p><b>Total geral:</b> {{ resumo.total_geral_br }}</p>
</div>

<div class="card">
  <h3>Gráfico (Top 12 cClass)</h3>
  <div style="max-width:520px; max-height:320px;">
    <canvas id="pizza" style="width:100%; height:320px;"></canvas>
  </div>
</div>

<div class="card">
  
  <div style="display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap;">
    <h3 style="margin:0;">Tabela por cClass</h3>
    <div style="display:flex; gap:8px; flex-wrap:wrap;">
      <button type="button" class="btn" id="cclass_expand_all">Expandir Todos</button>
      <button type="button" class="btn" id="cclass_collapse_all">Recolher Todos</button>
    </div>
  </div>

  <table id="tbl_cclass">
    <thead>
      <tr>
        <th style="width:38px;"></th>
        <th>cClass</th>
        <th>Descrição</th>
        <th>Qtd Itens</th>
        <th>Valor Total</th>
        <th>%</th>
      </tr>
    </thead>
    <tbody>
      {% for r in resumo.linhas %}
      <tr class="cclass-row" data-key="{{ loop.index }}">
        <td style="cursor:pointer; user-select:none;" class="cclass-toggle" aria-label="Expandir/Recolher">▶</td>
        <td>{{ r.cClass }}</td>
        <td>{{ r.desc }}</td>
        <td>{{ r.qtd_itens }}</td>
        <td>{{ r.v_total_br }}</td>
        <td>{{ r.pct_br }}%</td>
      </tr>
      <tr class="cclass-details" data-key="{{ loop.index }}" style="display:none;">
        <td colspan="6">
          <div style="padding:8px 0;">
            <div style="font-weight:600; margin-bottom:6px;">Notas e CFOPs usados nesta cClass</div>
            <table style="margin:0;">
              <thead>
                <tr>
                  <th>Nº Nota (nNF)</th>
                  <th>Contrato (cNF)</th>
                  <th>Emitente</th>
                  <th>Emissão</th>
                  <th>CFOP</th>
                  <th>Valor (somado na cClass)</th>
                </tr>
              </thead>
              <tbody>
                {% for n in r.notas %}
                <tr>
                  <td>{{ n.nNF }}</td>
                  <td>{{ n.cNF }}</td>
                  <td>{{ n.xNome }}</td>
                  <td>{{ n.dhEmi_fmt }}</td>
                  <td>{{ n.cfop }}</td>
                  <td>{{ n.vTotal_br }}</td>
                </tr>
                {% endfor %}
                {% if not r.notas %}
                <tr><td colspan="6" style="opacity:.75;">(sem notas)</td></tr>
                {% endif %}
              </tbody>
            </table>
          </div>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  <script>
  (function(){
    function setRow(key, open){
      const row = document.querySelector(`.cclass-row[data-key="${key}"]`);
      const det = document.querySelector(`.cclass-details[data-key="${key}"]`);
      if(!row || !det) return;
      const tgl = row.querySelector(".cclass-toggle");
      det.style.display = open ? "" : "none";
      if(tgl) tgl.textContent = open ? "▼" : "▶";
      row.dataset.open = open ? "1" : "0";
    }

    document.querySelectorAll(".cclass-row").forEach(r=>{
      r.addEventListener("click", (ev)=>{
        // só reage se clicar na linha ou na setinha
        const key = r.getAttribute("data-key");
        const open = r.dataset.open === "1";
        setRow(key, !open);
      });
    });

    const btnExp = document.getElementById("cclass_expand_all");
    const btnCol = document.getElementById("cclass_collapse_all");

    if(btnExp) btnExp.addEventListener("click", ()=>{
      document.querySelectorAll(".cclass-row").forEach(r=> setRow(r.getAttribute("data-key"), true));
    });
    if(btnCol) btnCol.addEventListener("click", ()=>{
      document.querySelectorAll(".cclass-row").forEach(r=> setRow(r.getAttribute("data-key"), false));
    });
  })();
  </script>

</div>

<div class="card">
  <div style="display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap;">
    <h3 style="margin:0;">Tabela de Itens (Todos)</h3>
    <div style="display:flex; gap:10px;">
      <button type="button" class="btn" onclick="expandirTodos()">Expandir Todos</button>
      <button type="button" class="btn" onclick="recolherTodos()">Recolher Todos</button>
    </div>
  </div>

  <style>
    .acc-toggle {
      cursor: pointer;
      user-select: none;
      font-weight: bold;
      display: inline-block;
      width: 20px;
      text-align: center;
    }
    tr.acc-detalhe {
      background: #f6f6f6;
    }
    .acc-box {
      padding: 10px;
      border-left: 3px solid #ddd;
    }
    table.table-interna {
      width: 100%;
      border-collapse: collapse;
      margin-top: 6px;
      font-size: 13px;
    }
    table.table-interna th, table.table-interna td {
      border: 1px solid #ddd;
      padding: 6px;
    }
    .num { text-align:right; }
  </style>

  <table>
    <thead>
      <tr>
        <th style="width:28px;"></th>
        <th>Item</th>
        <th style="width:90px;">cClass</th>
        <th style="width:90px;">Qtd Itens</th>
        <th style="width:140px;">Valor Total</th>
        <th style="width:80px;">%</th>
      </tr>
    </thead>
    <tbody>
      {% for it in resumo.itens_linhas %}
      {% set row_id = "acc_" ~ loop.index0 %}
      <tr>
        <td>
          <span class="acc-toggle" id="{{ row_id }}_ico" onclick="toggleAcc('{{ row_id }}')">▶</span>
        </td>
        <td>{{ it.item }}</td>
        <td>{{ it.cClass }}</td>
        <td class="num">{{ it.qtd_itens }}</td>
        <td class="num">{{ it.v_total_br }}</td>
        <td class="num">{{ it.pct_br }}%</td>
      </tr>

      <tr class="acc-detalhe" id="{{ row_id }}" style="display:none;">
        <td colspan="6">
          <div class="acc-box">
            <b>Notas fiscais relacionadas</b>
            {% if it.notas and it.notas|length > 0 %}
              <table class="table-interna">
                <thead>
                  <tr>
                    <th style="width:90px;">nNF</th>
                    <th style="width:120px;">Contrato (cNF)</th>
                    <th>Emitente (dest/xNome)</th>
                    <th style="width:110px;">Emissão</th>
                    <th style="width:140px;">Valor do item</th>
                  </tr>
                </thead>
                <tbody>
                  {% for n in it.notas %}
                  <tr>
                    <td>{{ n.nNF }}</td>
                    <td>{{ n.cNF }}</td>
                    <td>{{ n.xNome }}</td>
                    <td>{{ n.dhEmi_fmt }}</td>
                    <td class="num">{{ n.vProd_br }}</td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            {% else %}
              <div style="margin-top:8px; font-size:13px; opacity:0.85;">
                Nenhuma nota encontrada para este item.
              </div>
            {% endif %}
          </div>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<script>
  // Gráfico
  const labels = {{ resumo.labels|tojson }};
  const valores = {{ resumo.valores|tojson }};
  const ctx = document.getElementById("pizza");
  new Chart(ctx, {
    type: "pie",
    data: {
      labels: labels,
      datasets: [{ data: valores }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false
    }
  });

  // Accordion
  function toggleAcc(id) {
    const row = document.getElementById(id);
    const ico = document.getElementById(id + "_ico");
    const aberto = row.style.display !== "none";

    row.style.display = aberto ? "none" : "table-row";
    ico.textContent = aberto ? "▶" : "▼";
  }

  function expandirTodos() {
    const detalhes = document.querySelectorAll("tr.acc-detalhe");
    detalhes.forEach(tr => {
      tr.style.display = "table-row";
      const ico = document.getElementById(tr.id + "_ico");
      if (ico) ico.textContent = "▼";
    });
  }

  function recolherTodos() {
    const detalhes = document.querySelectorAll("tr.acc-detalhe");
    detalhes.forEach(tr => {
      tr.style.display = "none";
      const ico = document.getElementById(tr.id + "_ico");
      if (ico) ico.textContent = "▶";
    });
  }
</script>
{% endif %}

{% endblock %}
