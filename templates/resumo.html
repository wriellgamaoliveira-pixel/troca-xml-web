{% extends "base.html" %}
{% block content %}
<h1>Resumo (por cClass)</h1>

<div class="card">
  <form action="/resumo/gerar" method="post" enctype="multipart/form-data">
    <p><b>Envie um .zip</b> com XMLs:</p>
    <input type="file" name="zip_xmls" accept=".zip" required><br><br>
    <button class="btn" type="submit">Gerar Resumo</button>
  </form>
</div>

{% if resumo %}
<div class="card">
  <p><b>Total arquivos:</b> {{ resumo.total_arquivos }}</p>
  <p><b>Total geral:</b> {{ resumo.total_geral_br }}</p>
</div>

<div class="card">
  <h3>Gráfico (Top 12 cClass)</h3>

  <!-- trava tamanho do gráfico -->
  <div style="max-width:520px; height:320px;">
    <canvas id="pizza" style="width:100%; height:320px;"></canvas>
  </div>
</div>

<div class="card">
  <h3>Tabela por cClass</h3>
  <table>
    <thead>
      <tr>
        <th>cClass</th>
        <th>Qtd Itens</th>
        <th>Valor Total</th>
        <th>%</th>
      </tr>
    </thead>
    <tbody>
      {% for r in resumo.linhas %}
      <tr>
        <td>{{ r.cClass }}</td>
        <td>{{ r.qtd_itens }}</td>
        <td>{{ r.v_total_br }}</td>
        <td>{{ r.pct_br }}%</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<div class="card">
  <h3>Totalizadores por Itens (Top 50)</h3>
  <table>
    <thead>
      <tr>
        <th>ITENS_DA_NOTA</th>
        <th>cClass</th>
        <th>Qtd Itens</th>
        <th>Valor Total</th>
        <th>% do Total</th>
      </tr>
    </thead>
    <tbody>
      {% for r in resumo.itens_linhas[:50] %}
      <tr>
        <td>{{ r.item }}</td>
        <td>{{ r.cClass }}</td>
        <td style="text-align:right;">{{ r.qtd_itens }}</td>
        <td style="text-align:right;">{{ r.v_total_br }}</td>
        <td style="text-align:right;">{{ r.pct_br }}%</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  <p style="font-size:12px; opacity:0.8; margin-top:8px;">
    Mostrando os 50 maiores itens por valor.
  </p>
</div>

<script>
  const labels = {{ resumo.labels|tojson }};
  const valores = {{ resumo.valores|tojson }};

  const ctx = document.getElementById("pizza");
  new Chart(ctx, {
    type: "pie",
    data: {
      labels: labels,
      datasets: [{ data: valores }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false
    }
  });
</script>
{% endif %}

{% endblock %}
